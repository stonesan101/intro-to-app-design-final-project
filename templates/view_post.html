{% extends "base.html" %}

{% block title %}{{ post.title }} - Flask Blog{% endblock %}

{% block content %}
    <div class="card">
        <h2>{{ post.title }}</h2>
        <div class="post-meta">
            By <a href="{{ url_for('user_profile', user_id=post.author.id) }}">{{ post.author.username }}</a>
            on {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}
            {% if post.updated_at != post.created_at %}
                <span>(Updated: {{ post.updated_at.strftime('%B %d, %Y at %I:%M %p') }})</span>
            {% endif %}
        </div>

        <div class="post-content">
            {{ rendered_content|safe }}
        </div>

        {% if current_user.is_authenticated and current_user.id == post.author.id %}
            <div class="btn-group">
                <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn">Edit Post</a>
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="display: inline;"
                      onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button type="submit" class="btn btn-danger">Delete Post</button>
                </form>
            </div>
        {% endif %}
    </div>

    <div class="comment-section">
        <h3>Comments ({{ comments|length }})</h3>

        {% if current_user.is_authenticated %}
            <div class="card">
                <h4>Add a Comment</h4>
                <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}">
                    <div class="form-group">
                        <textarea name="content" placeholder="Write your comment..." required></textarea>
                    </div>
                    <button type="submit" class="btn">Post Comment</button>
                </form>
            </div>
        {% else %}
            <p><a href="{{ url_for('login') }}">Login</a> to leave a comment.</p>
        {% endif %}

        {% if comments %}
            {% for comment in comments %}
                <div class="comment">
                    <div class="comment-header">
                        <div>
                    <span class="comment-author">
                        <a href="{{ url_for('user_profile', user_id=comment.author.id) }}">{{ comment.author.username }}</a>
                    </span>
                            <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                        </div>
                        {% if current_user.is_authenticated and current_user.id == comment.author.id %}
                            <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                                  onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                <button type="submit" class="btn btn-danger"
                                        style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Delete
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    <p>{{ comment.rendered_content | safe }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p>No comments yet. Be the first to comment!</p>
        {% endif %}
    </div>
{% endblock %}